<!--index.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
  <view class="status-bar">
    <view class="status-left">
      <text class="app-title">MQTTæ§åˆ¶ä¸­å¿ƒ</text>
    </view>
    <view class="status-right">
      <view class="status-indicator {{connectionStatus}}">
        <text class="status-dot"></text>
        <text class="status-text">{{connectionText}}</text>
      </view>
    </view>
  </view>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <scroll-view class="main-content" scroll-y="true">
    <!-- é¦–é¡µ -->
    <view wx:if="{{activeTab === 'home'}}">
      <!-- è®¾å¤‡çŠ¶æ€å¡ç‰‡ -->
      <view class="status-card" wx:if="{{isConnected}}">
        <view class="card-header">
          <text class="card-title">å‹ç¼©æœºå®æ—¶ç›‘æ§</text>
          <view class="status-badge online">LIVE</view>
        </view>
        
        <!-- é£æ‰‡æ§åˆ¶åŒºåŸŸ -->
        <view class="control-section">
          <view class="section-title">é£æ‰‡æ§åˆ¶</view>
          <view class="fan-status {{fanStatus === 'running' ? 'running' : 'stopped'}}">
            <view class="fan-indicator {{fanStatus === 'running' ? 'running' : 'stopped'}}"></view>
            <view class="fan-info">
              <text class="fan-status-text">{{fanStatus === 'running' ? 'é£æ‰‡æ­£å¸¸è¿è½¬' : 'é£æ‰‡ä¿æŠ¤æ€§åœè½¬'}}</text>
              <text class="fan-reason">{{tempDiff !== null ? (tempDiff >= tempDiffThreshold ? 'æ¸©åº¦å·®è¶…æ ‡è§¦å‘ä¿æŠ¤' : 'æ¸©åº¦æ­£å¸¸ç»´æŒè¿è½¬') : 'ç­‰å¾…ä¼ æ„Ÿå™¨æ•°æ®'}}</text>
            </view>
          </view>
        </view>

        <!-- æ¸©åº¦ç›‘æ§åŒºåŸŸ -->
        <view class="monitor-section">
          <view class="section-title">æ¸©åº¦ç›‘æ§</view>
          <view class="temp-display">
            <view class="temp-item">
              <text class="temp-label">è¿›æ¸©</text>
              <text class="temp-value">{{comp1InTemp !== null ? comp1InTemp + 'Â°F' : '--'}}</text>
            </view>
            <view class="temp-arrow">â†’</view>
            <view class="temp-item">
              <text class="temp-label">å‡ºæ¸©</text>
              <text class="temp-value">{{comp1OutTemp !== null ? comp1OutTemp + 'Â°F' : '--'}}</text>
            </view>
          </view>
          <view class="threshold-setting">
            <text class="threshold-label">æ¸©å·®é˜ˆå€¼</text>
            <picker mode="selector" range="{{tempDiffOptions}}" value="{{tempDiffIndex}}" bindchange="onTempDiffChange">
              <view class="threshold-picker">
                <text>{{tempDiffThreshold}}Â°C</text>
                <text class="picker-arrow">â–¼</text>
              </view>
            </picker>
          </view>
        </view>
      </view>

      <!-- æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
      <view class="control-buttons" wx:if="{{isConnected}}">
        <view class="button-row">
          <button class="control-btn primary" bindtap="sendTestMessage">
            <text class="btn-icon">âš¡</text>
            <text class="btn-text">å‘é€æµ‹è¯•</text>
          </button>
          <button class="control-btn secondary" bindtap="clearMessages">
            <text class="btn-icon">ğŸ—‘ï¸</text>
            <text class="btn-text">æ¸…ç©ºè®°å½•</text>
          </button>
        </view>
        <view class="button-row">
          <button class="control-btn info" bindtap="switchTab" data-tab="messages">
            <text class="btn-icon">ğŸ“‹</text>
            <text class="btn-text">æ¶ˆæ¯åˆ—è¡¨</text>
          </button>
          <button class="control-btn warning" bindtap="switchTab" data-tab="settings">
            <text class="btn-icon">âš™ï¸</text>
            <text class="btn-text">ç³»ç»Ÿè®¾ç½®</text>
          </button>
        </view>
      </view>

      <!-- è®¾å¤‡é€‰æ‹©å™¨ -->
      <view class="device-selector" wx:if="{{isConnected && deviceList.length > 1}}">
        <view class="selector-label">é€‰æ‹©è®¾å¤‡</view>
        <picker bindchange="onDeviceSelect" range="{{deviceList}}" range-key="name">
          <view class="device-picker">
            <text class="selected-device">{{currentDeviceName || 'æœªé€‰æ‹©'}}</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>

      <!-- æœ€è¿‘æ¶ˆæ¯é¢„è§ˆ -->
      <view class="recent-messages" wx:if="{{messages.length > 0}}">
        <view class="section-header">
          <text class="section-title">æ¶ˆæ¯å†å²</text>
          <view class="view-all" bindtap="switchTab" data-tab="messages">
            <text>æŸ¥çœ‹å…¨éƒ¨</text>
            <text class="arrow">></text>
          </view>
        </view>
        <view class="message-list">
          <view wx:for="{{messages.slice(0, 3)}}" wx:key="index" class="message-item {{item.direction || 'received'}}">
            <view class="message-dot {{item.direction || 'received'}}"></view>
            <view class="message-content">
              <text class="message-topic">{{item.topic}}</text>
              <text class="message-payload">{{item.payload.length > 30 ? item.payload.substring(0, 30) + '...' : item.payload}}</text>
            </view>
            <text class="message-time">{{item.timestamp}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ¶ˆæ¯é¡µé¢ -->
    <view wx:if="{{activeTab === 'messages'}}">
      <!-- æ¶ˆæ¯è¿‡æ»¤ -->
      <view class="filter-bar">
        <view class="filter-tabs">
          <view class="filter-tab {{messageType === 'all' ? 'active' : ''}}" bindtap="onFilterTagTap" data-type="all">
            <text>å…¨éƒ¨</text>
          </view>
          <view class="filter-tab {{messageType === 'received' ? 'active' : ''}}" bindtap="onFilterTagTap" data-type="received">
            <text>æ¥æ”¶</text>
          </view>
          <view class="filter-tab {{messageType === 'sent' ? 'active' : ''}}" bindtap="onFilterTagTap" data-type="sent">
            <text>å‘é€</text>
          </view>
        </view>
        <view class="search-box">
          <input class="search-input" placeholder="æœç´¢æ¶ˆæ¯..." value="{{filterKeyword}}" bindinput="onFilterKeywordInput" />
        </view>
      </view>

      <!-- æ¶ˆæ¯åˆ—è¡¨ -->
      <view class="messages-container">
        <view class="list-header">
          <text class="list-count">å…± {{filteredMessages.length}} æ¡æ¶ˆæ¯</text>
        </view>
        <view class="full-message-list">
          <view wx:for="{{filteredMessages}}" wx:key="index" class="full-message-item {{item.direction || 'received'}}">
            <view class="item-header">
              <view class="type-badge {{item.direction || 'received'}}">
                <text>{{item.direction === 'sent' ? 'â†‘ å‘é€' : 'â†“ æ¥æ”¶'}}</text>
              </view>
              <text class="item-time">{{item.timestamp}}</text>
            </view>
            <view class="item-body">
              <text class="item-topic">{{item.topic}}</text>
              <text class="item-payload">{{item.payload}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å¯¼å‡ºæŒ‰é’® -->
      <view class="export-section" wx:if="{{filteredMessages.length > 0}}">
        <button class="export-btn" bindtap="exportMessagesAsJson">
          <text class="export-icon">ğŸ“„</text>
          <text>å¯¼å‡º JSON</text>
        </button>
        <button class="export-btn" bindtap="exportMessagesAsCsv">
          <text class="export-icon">ğŸ“Š</text>
          <text>å¯¼å‡º CSV</text>
        </button>
      </view>
    </view>

    <!-- è®¾ç½®é¡µé¢ -->
    <view wx:if="{{activeTab === 'settings'}}">
      <!-- æœåŠ¡å™¨é…ç½® -->
      <view class="config-section">
        <view class="section-title">æœåŠ¡å™¨é…ç½®</view>
        <view class="form-list">
          <view class="form-item">
            <text class="form-label">æœåŠ¡å™¨åœ°å€</text>
            <input class="form-input" value="{{serverConfig.broker}}" bindinput="onBrokerInput" />
          </view>
          <view class="form-item">
            <text class="form-label">ç«¯å£</text>
            <input class="form-input" type="number" value="{{serverConfig.port}}" bindinput="onPortInput" />
          </view>
          <view class="form-item">
            <text class="form-label">åè®®</text>
            <picker mode="selector" range="{{['wss', 'ws']}}" value="{{serverConfig.protocol === 'wss' ? 0 : 1}}" bindchange="onProtocolChange">
              <view class="picker-item">{{serverConfig.protocol}}</view>
            </picker>
          </view>
          <view class="form-item">
            <text class="form-label">å®¢æˆ·ç«¯ID</text>
            <input class="form-input" value="{{serverConfig.clientId}}" bindinput="onClientIdInput" />
          </view>
          <view class="form-item">
            <text class="form-label">ç”¨æˆ·å</text>
            <input class="form-input" value="{{serverConfig.username}}" bindinput="onUsernameInput" />
          </view>
          <view class="form-item">
            <text class="form-label">å¯†ç </text>
            <input class="form-input" password="{{!showPassword}}" value="{{serverConfig.password}}" bindinput="onPasswordInput" />
          </view>
        </view>
        <view class="action-buttons">
          <button class="action-btn secondary" bindtap="resetToDefault">é‡ç½®</button>
          <button class="action-btn primary" bindtap="saveServerConfig">ä¿å­˜é…ç½®</button>
        </view>
      </view>

      <!-- æ•°æ®ç»Ÿè®¡ -->
      <view class="stats-section">
        <view class="section-title">æ•°æ®ç»Ÿè®¡</view>
        <view class="stats-grid">
          <view class="stat-item">
            <view class="stat-icon receive">â†“</view>
            <text class="stat-number">{{receivedMessageCount}}</text>
            <text class="stat-label">æ¥æ”¶æ¶ˆæ¯</text>
          </view>
          <view class="stat-item">
            <view class="stat-icon send">â†‘</view>
            <text class="stat-number">{{sentMessageCount}}</text>
            <text class="stat-label">å‘é€æ¶ˆæ¯</text>
          </view>
          <view class="stat-item">
            <view class="stat-icon topic">#</view>
            <text class="stat-number">{{subscribedTopics.length}}</text>
            <text class="stat-label">è®¢é˜…ä¸»é¢˜</text>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <view class="bottom-nav">
    <view class="nav-item {{activeTab === 'home' ? 'active' : ''}}" bindtap="switchTab" data-tab="home">
      <view class="nav-icon">ğŸ </view>
      <text class="nav-label">é¦–é¡µ</text>
    </view>
    <view class="nav-item" bindtap="navigateToDevice">
      <view class="nav-icon">ğŸ“±</view>
      <text class="nav-label">è®¾å¤‡</text>
    </view>
    <view class="nav-item {{activeTab === 'messages' ? 'active' : ''}}" bindtap="switchTab" data-tab="messages">
      <view class="nav-icon">ğŸ“‹</view>
      <text class="nav-label">æ¶ˆæ¯</text>
      <view class="nav-badge" wx:if="{{messages.length > 0}}">{{messages.length > 99 ? '99+' : messages.length}}</view>
    </view>
    <view class="nav-item {{activeTab === 'settings' ? 'active' : ''}}" bindtap="switchTab" data-tab="settings">
      <view class="nav-icon">âš™ï¸</view>
      <text class="nav-label">è®¾ç½®</text>
    </view>
  </view>
</view>