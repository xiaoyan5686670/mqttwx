<!-- device.wxml -->
<view class="device-container">
  <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
  <view class="device-header">
    <view class="header-status {{isConnected ? 'connected' : 'disconnected'}}">
      <view class="status-dot"></view>
      <text class="status-text">{{connectionText}}</text>
    </view>
    <view class="header-actions">
      <view class="name-btn" bindtap="showNameConfigDialog">
        <text class="name-icon">âœ</text>
      </view>
      <view class="refresh-btn" bindtap="refreshData">
        <text class="refresh-icon">â†»</text>
      </view>
      <view class="config-btn" bindtap="showTopicConfigDialog">
        <text class="config-icon">âš™</text>
      </view>
    </view>
  </view>

  <!-- ä¸»å†…å®¹åŒº -->
  <scroll-view class="device-content" scroll-y="true">
    <!-- æ¸©æ¹¿åº¦å¡ç‰‡ -->
    <view class="sensor-card">
      <view class="card-header">
        <text class="card-title">æ¸©æ¹¿åº¦ç›‘æµ‹</text>
        <view class="card-decoration"></view>
      </view>

      <!-- ä¼ æ„Ÿå™¨1 -->
      <view class="sensor-group">
        <view class="sensor-header">
          <text class="sensor-label">{{deviceNames.sensor1}}</text>
          <view class="sensor-icon temperature">ğŸŒ¡</view>
        </view>
        <view class="sensor-values">
          <view class="value-item temp">
            <text class="value-label">æ¸©åº¦</text>
            <text class="value-number">{{deviceData.air_temperature_1 !== null ? deviceData.air_temperature_1 : '--'}}Â°C</text>
            <view class="value-bar">
              <view class="bar-fill" style="width: {{deviceData.air_temperature_1 !== null ? Math.min(Math.max((deviceData.air_temperature_1 + 10) / 50 * 100, 0), 100) : 0}}%"></view>
            </view>
          </view>
          <view class="value-item humidity">
            <text class="value-label">æ¹¿åº¦</text>
            <text class="value-number">{{deviceData.air_humidity_1 !== null ? deviceData.air_humidity_1 : '--'}}%</text>
            <view class="value-bar">
              <view class="bar-fill blue" style="width: {{deviceData.air_humidity_1 !== null ? Math.min(Math.max(deviceData.air_humidity_1, 0), 100) : 0}}%"></view>
            </view>
          </view>
        </view>
      </view>

      <!-- ä¼ æ„Ÿå™¨4 -->
      <view class="sensor-group">
        <view class="sensor-header">
          <text class="sensor-label">{{deviceNames.sensor4}}</text>
          <view class="sensor-icon temperature">ğŸŒ¡</view>
        </view>
        <view class="sensor-values">
          <view class="value-item temp">
            <text class="value-label">æ¸©åº¦</text>
            <text class="value-number">{{deviceData.air_temperature_4 !== null ? deviceData.air_temperature_4 : '--'}}Â°C</text>
            <view class="value-bar">
              <view class="bar-fill" style="width: {{deviceData.air_temperature_4 !== null ? Math.min(Math.max((deviceData.air_temperature_4 + 10) / 50 * 100, 0), 100) : 0}}%"></view>
            </view>
          </view>
          <view class="value-item humidity">
            <text class="value-label">æ¹¿åº¦</text>
            <text class="value-number">{{deviceData.air_humidity_4 !== null ? deviceData.air_humidity_4 : '--'}}%</text>
            <view class="value-bar">
              <view class="bar-fill blue" style="width: {{deviceData.air_humidity_4 !== null ? Math.min(Math.max(deviceData.air_humidity_4, 0), 100) : 0}}%"></view>
            </view>
          </view>
        </view>
      </view>

      <!-- æ›´æ–°æ—¶é—´ -->
      <view class="update-time">
        <text class="time-label">æœ€åæ›´æ–°: </text>
        <text class="time-value">{{lastUpdateTime || 'æœªæ¥æ”¶æ•°æ®'}}</text>
        <text wx:if="{{dataTimeout}}" class="timeout-warning"> (æ•°æ®è¶…æ—¶)</text>
      </view>
    </view>

    <!-- ç»§ç”µå™¨æ§åˆ¶å¡ç‰‡ -->
    <view class="relay-card">
      <view class="card-header">
        <text class="card-title">ç»§ç”µå™¨æ§åˆ¶</text>
        <view class="card-decoration"></view>
      </view>

      <!-- ä¸»ç»§ç”µå™¨ -->
      <view class="relay-control {{isRelayChanging ? 'changing' : ''}}">
        <view class="relay-info">
          <text class="relay-name">{{deviceNames.relay}}</text>
          <text class="relay-status {{deviceData.relay_status}}">{{deviceData.relay_status === 'on' ? 'å·²å¼€å¯' : 'å·²å…³é—­'}}</text>
          <text wx:if="{{isRelayChanging}}" class="changing-hint">åŒæ­¥ä¸­...</text>
        </view>
        <view class="relay-switch {{deviceData.relay_status}} {{isRelayChanging ? 'disabled' : ''}}" bindtap="toggleRelay">
          <view class="switch-track">
            <view class="switch-knob"></view>
          </view>
          <view class="switch-glow"></view>
        </view>
      </view>

      <!-- å†…éƒ¨ç»§ç”µå™¨ -->
      <view class="relay-control">
        <view class="relay-info">
          <text class="relay-name">{{deviceNames.relayIn}}</text>
          <text class="relay-status {{deviceData.relay_in_status}}">{{deviceData.relay_in_status === 'on' ? 'å·²å¼€å¯' : 'å·²å…³é—­'}}</text>
        </view>
        <view class="relay-switch {{deviceData.relay_in_status}}" bindtap="toggleRelayIn">
          <view class="switch-track">
            <view class="switch-knob"></view>
          </view>
          <view class="switch-glow"></view>
        </view>
      </view>
    </view>

    <!-- è®¢é˜…çŠ¶æ€ -->
    <view class="status-card">
      <view class="status-row">
        <text class="status-row-label">è®¢é˜…ä¸»é¢˜</text>
        <text class="status-row-value">{{subscribeTopic}}</text>
      </view>
      <view class="status-row">
        <text class="status-row-label">è®¢é˜…çŠ¶æ€</text>
        <text class="status-row-value {{isSubscribed ? 'active' : 'inactive'}}">{{isSubscribed ? 'å·²è®¢é˜…' : 'æœªè®¢é˜…'}}</text>
      </view>
    </view>

    <!-- åº•éƒ¨ç•™ç™½ -->
    <view class="bottom-spacer"></view>
  </scroll-view>

  <!-- ä¸»é¢˜é…ç½®å¯¹è¯æ¡† -->
  <view class="dialog-mask" wx:if="{{showTopicConfig}}" bindtap="hideTopicConfigDialog">
    <view class="dialog-content" catchtap="stopPropagation">
      <view class="dialog-header">
        <text class="dialog-title">ä¸»é¢˜é…ç½®</text>
        <view class="dialog-close" bindtap="hideTopicConfigDialog">Ã—</view>
      </view>
      <view class="dialog-body">
        <view class="config-item">
          <text class="config-label">è®¢é˜…ä¸»é¢˜ (æ¥æ”¶æ•°æ®)</text>
          <input class="config-input" value="{{subscribeInput}}" bindinput="onSubscribeTopicInput" placeholder="è¾“å…¥è®¢é˜…ä¸»é¢˜" />
        </view>
        <view class="config-item">
          <text class="config-label">å‘å¸ƒä¸»é¢˜ (æ§åˆ¶ä¸»ç»§ç”µå™¨)</text>
          <input class="config-input" value="{{publishRelayInput}}" bindinput="onPublishRelayTopicInput" placeholder="è¾“å…¥å‘å¸ƒä¸»é¢˜" />
        </view>
        <view class="config-item">
          <text class="config-label">å‘å¸ƒä¸»é¢˜ (æ§åˆ¶å†…éƒ¨ç»§ç”µå™¨)</text>
          <input class="config-input" value="{{publishRelayInInput}}" bindinput="onPublishRelayInTopicInput" placeholder="è¾“å…¥å‘å¸ƒä¸»é¢˜" />
        </view>
      </view>
      <view class="dialog-footer">
        <button class="dialog-btn secondary" bindtap="hideTopicConfigDialog">å–æ¶ˆ</button>
        <button class="dialog-btn primary" bindtap="saveTopicSettings">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- åç§°é…ç½®å¯¹è¯æ¡† -->
  <view class="dialog-mask" wx:if="{{showNameConfig}}" bindtap="hideNameConfigDialog">
    <view class="dialog-content" catchtap="stopPropagation">
      <view class="dialog-header">
        <text class="dialog-title">è®¾å¤‡åç§°</text>
        <view class="dialog-close" bindtap="hideNameConfigDialog">Ã—</view>
      </view>
      <view class="dialog-body">
        <view class="config-item">
          <text class="config-label">ä¼ æ„Ÿå™¨ 1 åç§°</text>
          <input class="config-input" value="{{nameSensor1Input}}" bindinput="onNameSensor1Input" placeholder="è¾“å…¥ä¼ æ„Ÿå™¨ 1 åç§°" />
        </view>
        <view class="config-item">
          <text class="config-label">ä¼ æ„Ÿå™¨ 4 åç§°</text>
          <input class="config-input" value="{{nameSensor4Input}}" bindinput="onNameSensor4Input" placeholder="è¾“å…¥ä¼ æ„Ÿå™¨ 4 åç§°" />
        </view>
        <view class="config-item">
          <text class="config-label">ä¸»ç»§ç”µå™¨åç§°</text>
          <input class="config-input" value="{{nameRelayInput}}" bindinput="onNameRelayInput" placeholder="è¾“å…¥ä¸»ç»§ç”µå™¨åç§°" />
        </view>
        <view class="config-item">
          <text class="config-label">å†…éƒ¨ç»§ç”µå™¨åç§°</text>
          <input class="config-input" value="{{nameRelayInInput}}" bindinput="onNameRelayInInput" placeholder="è¾“å…¥å†…éƒ¨ç»§ç”µå™¨åç§°" />
        </view>
      </view>
      <view class="dialog-footer">
        <button class="dialog-btn secondary" bindtap="hideNameConfigDialog">å–æ¶ˆ</button>
        <button class="dialog-btn primary" bindtap="saveNameSettings">ä¿å­˜</button>
      </view>
    </view>
  </view>
</view>
