<!-- device.wxml -->
<view class="device-container">
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <view class="device-header">
      <view class="header-left">
        <view class="header-status {{isConnected ? 'connected' : 'disconnected'}}">
          <view class="status-dot"></view>
          <text class="status-text">{{connectionText}}</text>
        </view>
        <view class="device-selector" bindtap="showDeviceManageDialog">
          <text class="device-name">{{currentDeviceName || 'è®¾å¤‡'}}</text>
          <text class="device-arrow">â–¼</text>
        </view>
      </view>
      <view class="header-actions">
        <view class="add-device-btn" bindtap="showAddDeviceDialog">
          <text class="add-device-icon">+</text>
        </view>
        
        <!-- æ›´å¤šæ“ä½œèœå• -->
        <view class="more-menu-btn" bindtap="toggleMoreMenu">
          <text class="more-menu-icon">â‹®</text>
        </view>
        
        <!-- ä¸‹æ‹‰èœå• -->
        <view class="more-menu-dropdown {{showMoreMenu ? 'show' : ''}}">
          <view class="menu-item" bindtap="showSensorManageDialog">
            <text class="menu-icon">ğŸ“Š</text>
            <text class="menu-text">ä¼ æ„Ÿå™¨ç®¡ç†</text>
          </view>
          <view class="menu-item" bindtap="showNameConfigDialog">
            <text class="menu-icon">âœ</text>
            <text class="menu-text">ç»§ç”µå™¨åç§°</text>
          </view>
          <view class="menu-item" bindtap="refreshData">
            <text class="menu-icon">â†»</text>
            <text class="menu-text">åˆ·æ–°æ•°æ®</text>
          </view>
          <view class="menu-item" bindtap="showTopicConfigDialog">
            <text class="menu-icon">âš™</text>
            <text class="menu-text">ä¸»é¢˜é…ç½®</text>
          </view>
        </view>
        
        <!-- é®ç½©å±‚ -->
        <view class="menu-overlay {{showMoreMenu ? 'show' : ''}}" bindtap="hideMoreMenu"></view>
      </view>
    </view>

  <!-- ä¸»å†…å®¹åŒº -->
  <view wx:if="{{deviceList.length > 0}}">
    <scroll-view class="device-content" scroll-y="true">
      <!-- æ¸©æ¹¿åº¦å¡ç‰‡ -->
      <view class="sensor-card">
        <view class="card-header">
          <text class="card-title">ä¼ æ„Ÿå™¨ç›‘æµ‹</text>
          <view class="card-decoration"></view>
        </view>

        <!-- åŠ¨æ€æ¸²æŸ“ä¼ æ„Ÿå™¨ -->
        <block wx:for="{{sensorConfig}}" wx:key="id">
          <view class="sensor-group" wx:if="{{item.visible}}">
            <view class="sensor-header">
              <text class="sensor-label">{{item.label}}</text>
              <view class="sensor-icon {{item.type}}">{{item.type === 'env' ? 'ğŸŒ¡' : 'â„'}}</view>
            </view>
            <view class="sensor-values">
              <view class="value-item temp">
                <text class="value-label">æ¸©åº¦</text>
                <text class="value-number">{{deviceData[item.tempField] !== null ? deviceData[item.tempField] : '--'}}{{item.unit}}</text>
                <view class="value-bar">
                  <view class="bar-fill {{item.type === 'env' ? '' : 'blue'}}" style="width: 0%;"></view>
                </view>
              </view>
              <view class="value-item humidity" wx:if="{{item.type === 'env'}}">
                <text class="value-label">æ¹¿åº¦</text>
                <text class="value-number">{{deviceData[item.humidityField] !== null ? deviceData[item.humidityField] : '--'}}%</text>
                <view class="value-bar">
                  <view class="bar-fill blue" style="width: 0%;"></view>
                </view>
              </view>
            </view>
          </view>
        </block>

        <!-- æ›´æ–°æ—¶é—´ -->
        <view class="update-time">
          <text class="time-label">æœ€åæ›´æ–°: </text>
          <text class="time-value">{{lastUpdateTime || 'æœªæ¥æ”¶æ•°æ®'}}</text>
          <text wx:if="{{dataTimeout}}" class="timeout-warning"> (æ•°æ®è¶…æ—¶)</text>
        </view>
      </view>

      <!-- ç»§ç”µå™¨æ§åˆ¶å¡ç‰‡ -->
      <view class="relay-card">
        <view class="card-header">
          <text class="card-title">ç»§ç”µå™¨æ§åˆ¶</text>
          <view class="card-decoration"></view>
        </view>

        <!-- ä¸»ç»§ç”µå™¨ -->
        <view class="relay-control {{isRelayChanging ? 'changing' : ''}}">
          <view class="relay-info">
            <text class="relay-name">{{relayNames.main}}</text>
            <text class="relay-status {{relay_status}}">{{relay_status === 'on' ? 'å·²å¼€å¯' : 'å·²å…³é—­'}}</text>
            <text wx:if="{{isRelayChanging}}" class="changing-hint">åŒæ­¥ä¸­...</text>
          </view>
          <view class="relay-switch {{relay_status}} {{isRelayChanging ? 'disabled' : ''}}" bindtap="toggleRelay">
            <view class="switch-track">
              <view class="switch-knob"></view>
            </view>
            <view class="switch-glow"></view>
          </view>
        </view>

        <!-- å†…éƒ¨ç»§ç”µå™¨ -->
        <view class="relay-control">
          <view class="relay-info">
            <text class="relay-name">{{relayNames.internal}}</text>
            <text class="relay-status {{relay_in_status}}">{{relay_in_status === 'on' ? 'å·²å¼€å¯' : 'å·²å…³é—­'}}</text>
          </view>
          <view class="relay-switch {{relay_in_status}}" bindtap="toggleRelayIn">
            <view class="switch-track">
              <view class="switch-knob"></view>
            </view>
            <view class="switch-glow"></view>
          </view>
        </view>
      </view>

      <!-- è®¢é˜…çŠ¶æ€ -->
      <view class="status-card">
        <view class="status-row">
          <text class="status-row-label">è®¢é˜…ä¸»é¢˜</text>
          <text class="status-row-value">{{subscribeTopic}}</text>
        </view>
        <view class="status-row">
          <text class="status-row-label">è®¢é˜…çŠ¶æ€</text>
          <text class="status-row-value {{isSubscribed ? 'active' : 'inactive'}}">{{isSubscribed ? 'å·²è®¢é˜…' : 'æœªè®¢é˜…'}}</text>
        </view>
      </view>

      <!-- åº•éƒ¨ç•™ç™½ -->
      <view class="bottom-spacer"></view>
    </scroll-view>
  </view>

  <!-- ç©ºçŠ¶æ€æç¤º -->
  <view wx:else class="empty-state">
    <text class="empty-icon">ğŸ“±</text>
    <text class="empty-text">æš‚æ— è®¾å¤‡</text>
    <text class="empty-hint">è¯·ç‚¹å‡»å³ä¸Šè§’â€œ+â€æ·»åŠ è®¾å¤‡</text>
  </view>

  <!-- ä¸»é¢˜é…ç½®å¯¹è¯æ¡† -->
  <view class="dialog-mask" wx:if="{{showTopicConfig}}" bindtap="hideTopicConfigDialog">
    <view class="dialog-content" catchtap="stopPropagation">
      <view class="dialog-header">
        <text class="dialog-title">ä¸»é¢˜é…ç½®</text>
        <view class="dialog-close" bindtap="hideTopicConfigDialog">Ã—</view>
      </view>
      <view class="dialog-body">
        <view class="config-item">
          <text class="config-label">è®¢é˜…ä¸»é¢˜ (æ¥æ”¶æ•°æ®)</text>
          <input class="config-input" value="{{subscribeInput}}" bindinput="onSubscribeTopicInput" placeholder="è¾“å…¥è®¢é˜…ä¸»é¢˜" />
        </view>
        <view class="config-item">
          <text class="config-label">å‘å¸ƒä¸»é¢˜ (æ§åˆ¶ä¸»ç»§ç”µå™¨)</text>
          <input class="config-input" value="{{publishRelayInput}}" bindinput="onPublishRelayTopicInput" placeholder="è¾“å…¥å‘å¸ƒä¸»é¢˜" />
        </view>
        <view class="config-item">
          <text class="config-label">å‘å¸ƒä¸»é¢˜ (æ§åˆ¶å†…éƒ¨ç»§ç”µå™¨)</text>
          <input class="config-input" value="{{publishRelayInInput}}" bindinput="onPublishRelayInTopicInput" placeholder="è¾“å…¥å‘å¸ƒä¸»é¢˜" />
        </view>
      </view>
      <view class="dialog-footer">
        <button class="dialog-btn secondary" bindtap="hideTopicConfigDialog">å–æ¶ˆ</button>
        <button class="dialog-btn primary" bindtap="saveTopicSettings">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- åç§°é…ç½®å¯¹è¯æ¡† -->
  <view class="dialog-mask" wx:if="{{showNameConfig}}" bindtap="hideNameConfigDialog">
    <view class="dialog-content" catchtap="stopPropagation">
      <view class="dialog-header">
        <text class="dialog-title">ç»§ç”µå™¨åç§°</text>
        <view class="dialog-close" bindtap="hideNameConfigDialog">Ã—</view>
      </view>
      <view class="dialog-body">
        <view class="config-item">
          <text class="config-label">ä¸»ç»§ç”µå™¨åç§°</text>
          <input class="config-input" value="{{nameRelayInput}}" bindinput="onNameRelayInput" placeholder="è¾“å…¥ä¸»ç»§ç”µå™¨åç§°" />
        </view>
        <view class="config-item">
          <text class="config-label">å†…éƒ¨ç»§ç”µå™¨åç§°</text>
          <input class="config-input" value="{{nameRelayInInput}}" bindinput="onNameRelayInInput" placeholder="è¾“å…¥å†…éƒ¨ç»§ç”µå™¨åç§°" />
        </view>
      </view>
      <view class="dialog-footer">
        <button class="dialog-btn secondary" bindtap="hideNameConfigDialog">å–æ¶ˆ</button>
        <button class="dialog-btn primary" bindtap="saveNameSettings">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- ä¼ æ„Ÿå™¨ç®¡ç†å¯¹è¯æ¡† -->
  <view class="dialog-mask" wx:if="{{showSensorManage}}" bindtap="hideSensorManageDialog">
    <view class="dialog-content sensor-manage-dialog" catchtap="stopPropagation">
      <view class="dialog-header">
        <text class="dialog-title">ä¼ æ„Ÿå™¨ç®¡ç†</text>
        <view class="dialog-close" bindtap="hideSensorManageDialog">Ã—</view>
      </view>
      <view class="dialog-body sensor-manage-body">
        <view class="sensor-manage-list">
          <block wx:for="{{sensorConfig}}" wx:key="id">
            <view class="sensor-manage-item">
              <view class="sensor-manage-info">
                <text class="sensor-manage-type">{{item.type === 'env' ? 'ğŸŒ¡' : 'â„'}}</text>
                <input class="sensor-manage-input" value="{{item.label}}" bindinput="onSensorLabelInput" data-index="{{index}}" placeholder="è¾“å…¥ä¼ æ„Ÿå™¨åç§°" />
              </view>
              <view class="sensor-manage-toggle {{item.visible ? 'visible' : 'hidden'}}" bindtap="toggleSensorVisibility" data-index="{{index}}">
                {{item.visible ? 'ğŸ‘' : 'ğŸ‘â€ğŸ—¨'}}
              </view>
            </view>
          </block>
        </view>
      </view>
      <view class="dialog-footer">
        <button class="dialog-btn secondary" bindtap="resetSensorConfig">è¿˜åŸé»˜è®¤</button>
        <button class="dialog-btn secondary" bindtap="hideSensorManageDialog">å–æ¶ˆ</button>
        <button class="dialog-btn primary" bindtap="saveSensorManageSettings">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- è®¾å¤‡ç®¡ç†å¯¹è¯æ¡† -->
  <view class="dialog-mask" wx:if="{{showDeviceManage}}" bindtap="hideDeviceManageDialog">
    <view class="dialog-content device-manage-dialog" catchtap="stopPropagation">
      <view class="dialog-header">
        <text class="dialog-title">è®¾å¤‡åˆ—è¡¨</text>
        <view class="dialog-close" bindtap="hideDeviceManageDialog">Ã—</view>
      </view>
      <view class="dialog-body device-manage-body">
        <view class="device-manage-list">
          <block wx:for="{{deviceList}}" wx:key="id">
        <view class="device-manage-item {{currentDeviceId === item.id ? 'active' : ''}}">
          <view class="device-manage-info" bindtap="switchToDevice" data-id="{{item.id}}">
            <text class="device-manage-name">{{item.name}}</text>
            <text class="device-manage-topic">{{item.subscribeTopic}}</text>
          </view>
          <view class="device-manage-actions">
            <view wx:if="{{currentDeviceId !== item.id}}" class="device-manage-switch-icon" bindtap="switchToDevice" data-id="{{item.id}}">â†’</view>
            <view class="device-manage-active-icon" wx:if="{{currentDeviceId === item.id}}">âœ“</view>
            <view class="device-manage-delete" bindtap="deleteDevice" catchtap="stopPropagation" data-id="{{item.id}}">ğŸ—‘</view>
          </view>
        </view>
          </block>
        </view>
      </view>
      <view class="dialog-footer">
        <button class="dialog-btn primary" bindtap="hideDeviceManageDialog">å…³é—­</button>
      </view>
    </view>
  </view>

  <!-- æ–°å¢è®¾å¤‡å¯¹è¯æ¡† -->
  <view class="dialog-mask" wx:if="{{showAddDevice}}" bindtap="hideAddDeviceDialog">
    <view class="dialog-content" catchtap="stopPropagation">
      <view class="dialog-header">
        <text class="dialog-title">æ–°å¢è®¾å¤‡</text>
        <view class="dialog-close" bindtap="hideAddDeviceDialog">Ã—</view>
      </view>
      <view class="dialog-body">
        <view class="config-item">
          <text class="config-label">è®¾å¤‡åç§°</text>
          <input class="config-input" value="{{newDeviceName}}" bindinput="onNewDeviceNameInput" placeholder="è¾“å…¥è®¾å¤‡åç§°" />
        </view>
        <view class="config-item">
          <text class="config-label">è®¢é˜…ä¸»é¢˜</text>
          <input class="config-input" value="{{newDeviceTopic}}" bindinput="onNewDeviceTopicInput" placeholder="è¾“å…¥è®¢é˜…ä¸»é¢˜" />
        </view>
      </view>
      <view class="dialog-footer">
        <button class="dialog-btn secondary" bindtap="hideAddDeviceDialog">å–æ¶ˆ</button>
        <button class="dialog-btn primary" bindtap="addDevice">æ·»åŠ </button>
      </view>
    </view>
  </view>
</view>
