# WeChat Mini Program MQTT Client

一个完整的微信小程序 MQTT 客户端，支持连接到 MQTT 服务器，具有发布、订阅和消息管理功能。

## 功能特性

### 核心功能
- ✅ 连接到 MQTT 服务器（支持公共服务器和私有服务器）
- ✅ 实时连接状态显示
- ✅ 主题订阅和取消订阅（含完整 UNSUBSCRIBE 协议支持）
- ✅ 消息发布功能
- ✅ 消息历史记录
- ✅ 数据本地存储
- ✅ 用户名/密码认证

### 新增功能 🔥
- ✅ QoS 等级支持（QoS 0/1/2）
- ✅ 消息过滤（按关键词、主题、类型筛选）
- ✅ 消息导出（JSON、CSV 格式）
- ✅ 消息统计分析
- ✅ UTF-8 编码完整支持（支持中文和多字节字符）
- ✅ 配置管理工具（统一配置导入/导出）

## 项目结构

```
miniprogram-1/
├── app.js              # 应用入口文件
├── app.json            # 应用配置
├── app.wxss            # 全局样式
├── pages/
│   └── index/
│       ├── index.js    # 主页逻辑
│       ├── index.wxml  # 主页模板
│       ├── index.wxss  # 主页样式
│       └── index.json  # 页面配置
├── utils/
│   └── mqtt.js         # MQTT 客户端封装
└── README.md           # 项目说明
```

## 使用方法

### 1. 连接 MQTT 服务器

1. 打开小程序
2. 点击"连接到MQTT"按钮
3. 等待连接成功提示

### 2. 订阅主题

1. 在"主题管理"区域输入要订阅的主题名称（如：test/topic）
2. 点击"订阅"按钮
3. 主题将出现在已订阅列表中

### 3. 发布消息

1. 在"发布消息"区域输入目标主题
2. 输入要发送的消息内容
3. 点击"发送消息"按钮
4. 消息将显示在消息历史中

### 4. 查看消息

- 所有接收到的消息都会显示在"消息历史"区域
- 消息按时间倒序排列
- 显示主题名称、消息内容和接收时间

## 技术实现

### MQTT 协议实现
- 纯原生实现 MQTT 3.1.1 协议
- 支持 CONNECT/SUBSCRIBE/UNSUBSCRIBE/PUBLISH/PINGREQ 等核心协议
- 完整的 UTF-8 编码/解码支持
- QoS 0/1/2 等级支持
- 使用 wx.connectSocket 进行 WebSocket 连接

### MQTT 连接

- 支持公共服务器和私有服务器配置
- 服务器地址：默认 `wss://broker.emqx.io:8084/mqtt`
- 支持自动重连机制（可配置）
- 完善的错误处理和状态管理
- 超时管理（CONNACK 和整体连接超时）

### 数据存储

- 已订阅主题列表持久化存储
- 消息历史记录持久化存储
- 使用微信小程序的 `wx.setStorageSync` API

### 用户界面

- 响应式设计，适配不同屏幕尺寸
- 连接状态实时显示和动画效果
- 简洁直观的操作界面

## 开发说明

### MQTT 客户端实现

`utils/mqtt.js` 文件基于 EMQX 官方示例实现：

- 使用官方 MQTT.js 库（mqtt.min.js）进行 WebSocket 连接
- 专为微信小程序优化的 WebSocket 适配器
- MQTT 协议完整功能支持
- 自动重连机制
- 完善的事件回调和状态管理
- 标准的订阅/发布 API
- 完整的错误处理和状态管理

### 页面逻辑

`pages/index/index.js` 处理所有用户交互：

- MQTT 客户端事件监听
- 数据绑定和状态管理
- 用户输入验证
- 本地存储管理

## 注意事项

1. **网络权限**：确保小程序已配置网络请求权限
2. **WebSocket 支持**：微信小程序支持 WebSocket 连接
3. **主题命名**：建议使用有意义的主题名称，如 `device/sensor/temperature`
4. **消息大小**：建议消息内容不要过大，以保证传输效率
5. **连接稳定性**：已添加错误处理和重连机制，提高连接稳定性

## 常见问题

### WebSocket 连接错误
如果遇到 "未完成的操作" 错误，请检查：
- 网络连接是否正常
- EMQX 服务器地址是否正确
- 小程序是否已配置网络请求权限

### showLoading/hideLoading 配对使用错误
如果遇到 showLoading 与 hideLoading 必须配对使用的错误：
- 已修复：使用 try-finally 结构确保 loading 状态正确清理
- 连接成功或失败都会自动隐藏 loading 提示
- 提供更好的用户体验

### 连接超时
如果连接超时，请尝试：
- 检查网络环境
- 确认 EMQX 服务器是否可访问
- 重启小程序重试

## 新增功能详情

### 1. QoS 等级支持
- **QoS 0**: 最多一次（不保证送达）
- **QoS 1**: 至少一次（保证送达，可能重复）
- **QoS 2**: 恰好一次（保证送达且不重复）

可在订阅和发布时分别选择 QoS 等级。

### 2. 消息过滤
- **关键词搜索**: 按主题名或消息内容搜索
- **主题过滤**: 仅显示特定主题的消息
- **类型过滤**: 可选择查看全部/发送/接收的消息

### 3. 消息导出
- **JSON 格式**: 完整的消息数据和元信息，便于程序处理
- **CSV 格式**: 可在 Excel 中打开，适合数据分析
- 导出内容包括时间、主题、方向、消息内容

### 4. 消息统计
- 显示总消息数、发送/接收数量
- 按主题统计消息分布
- 支持复制统计信息

### 5. 配置管理
- 统一配置存储（服务器列表、QoS 设置、日志级别等）
- 支持配置导入/导出
- 配置版本控制

### 6. UTF-8 编码支持
- 完整支持中文和多字节字符
- 正确处理 Unicode 字符（包括 emoji）
- 使用 TextEncoder API 进行编码

## 许可证

MIT License

## 贡献

欢迎提交 Issue 和 Pull Request！

## 更新日志

### v1.1.0 (当前版本)
- ✅ 添加 QoS 等级支持
- ✅ 实现完整的 UNSUBSCRIBE 协议
- ✅ 添加消息过滤功能
- ✅ 支持消息导出（JSON/CSV）
- ✅ 添加消息统计分析
- ✅ 修复 UTF-8 编码问题
- ✅ 添加配置管理工具
- ✅ 删除重复的 onUnload 方法

### v1.0.0 (初始版本)
- ✅ 基础 MQTT 连接功能
- ✅ 主题订阅/发布
- ✅ 消息历史记录
- ✅ 服务器配置管理
- ✅ 用户名密码认证